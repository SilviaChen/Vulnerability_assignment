from flask import jsonify, request
from api.vulnerabilities import get_all_vulnerabilities


def calculate_asset_score(asset_id, scan_id):
    vulner = get_all_vulnerabilities()
    tmp = []
    for i in vulner:
        if i["from_scan"] == int(scan_id) and int(asset_id) in i["affected_assets"]:
            modify_data = {
                'id': i["id"],
                'score': i["cvss_base_score"]
            }
            tmp.append(modify_data)
    total_score = 0.0
    for t in tmp:
        total_score += float(t['score'])
    return total_score


def get_score():
    asset_id = request.args['asset_id']
    scan_id = request.args['scan_id']
    return_value = jsonify({'Score': calculate_asset_score(asset_id, scan_id)})
    return return_value
